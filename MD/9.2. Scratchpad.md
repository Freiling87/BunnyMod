# RogueLibs v3 & SOR v95 Updates


### Final
- Test every single feature, as there's a good chance some of it is subtly broken.

# Scratchpad
These are my test notes. Feel free to look around if you're curious about what I'm working on.

---

- Roamin' Orgy - Try setting agent.ModLeashes to 0

- Wall Mods - There might be an rList setup somewhere to determine wall types. It's possible you saw "Normal Walls" and didn't realize it's the name of the level editor group?

- Entered arena fight, and when I entered the arena I got this:
    - [Error  : Unity Log] NullReferenceException: Object reference not set to an instance of an object
        Stack trace:
        EventTriggerFloor.ArenaEnter (Agent myAgent) (at <5b00a25014d74f7f862ecdd1d48f7c04>:0)
        EventTriggerFloor.DoTriggerEnter (Agent myAgent) (at <5b00a25014d74f7f862ecdd1d48f7c04>:0)
        EventTriggerFloor.OnTriggerEnter2D (UnityEngine.Collider2D other) (at <5b00a25014d74f7f862ecdd1d48f7c04>:0)


- Used public turntables, spun records, got fail noise, and this:

```
[Message: Bunny Mod] Turntables (2407): ObjectReal_PressedButton
[Error  : Unity Log] NullReferenceException: Object reference not set to an instance of an object
Stack trace:
SpawnerMain.SpawnDanger (PlayfieldObject playfieldObject, System.String dangerType, System.String dangerSize, Agent dangerTarget) (at <5b00a25014d74f7f862ecdd1d48f7c04>:0)
SpawnerMain.SpawnDanger (PlayfieldObject playfieldObject, System.String dangerType, System.String dangerSize) (at <5b00a25014d74f7f862ecdd1d48f7c04>:0)
Turntables.PlayBadMusic () (at <5b00a25014d74f7f862ecdd1d48f7c04>:0)
Turntables.SpinRecords () (at <5b00a25014d74f7f862ecdd1d48f7c04>:0)
Turntables.PressedButton (System.String buttonText, System.Int32 buttonPrice) (at <5b00a25014d74f7f862ecdd1d48f7c04>:0)
ObjectReal.PressedButton (System.String buttonText) (at <5b00a25014d74f7f862ecdd1d48f7c04>:0)
WorldSpaceGUI.PressedButton (System.Int32 buttonNum) (at <5b00a25014d74f7f862ecdd1d48f7c04>:0)
ButtonHelper.PushButton () (at <5b00a25014d74f7f862ecdd1d48f7c04>:0)
ButtonHelper.DoUpdate (System.Boolean onlySetImages) (at <5b00a25014d74f7f862ecdd1d48f7c04>:0)
ButtonHelper.Update () (at <5b00a25014d74f7f862ecdd1d48f7c04>:0)
```

- Used Police Radio on someone, they just followed them and didn't go hostile

- Started a run with Green Living & Arcology, and it seemed that wall ownership got broken. 
  - All owned doors in one base showed "open/knock/done" prompt, even inside doors
  - Door knocking worked fine, but most would not flee a building if it was burning. 
  - So my best guess is that the affected walls' owner is getting cleared out somewhere.

#
# Implementation
Features for the current update designated to be within scope.

---
 
## 00 Priority - Upgrade to Roguelibs 3b compatibility

## All dialogue
- Whichever one has mugging code in it is not longer working. Guessing it's where Veiled Threats is coded.
- BMAbilities
  - Refactored these completely.
  - Test Pyro burnout noise, need to eliminate that.
- BMAgents
- BMBehaviors
- BMChallenges
- BMCombat
- BMInterface
- BMItems
- BMLevelFeelings
- BMLevelGen
- BMMiscellaneous
- BMObjects
  - FlamingBarrel DW
  - SlotMachine DW
- BMQuests
- BMSprites
- BMTraits
## ATMMachine
- Button always says "Pay Cop Debt", even when it should say "Bribe Cops" (At least I think the latter is used in ATM)
- Had option to pay cops even if I had already done it (did it in person though, not at machine)
## Bodyguarded/ +
- Limit numbers to follower count.
  - I think if it exceeds it, they can't path? Not sure.
- Improve type (Goon/Super/Soldier) with Confident in Crowds or something
- Improve equipment with Reinforcements?
## Eagle Eyes
- Need a multiplayer version of GetZoomLevel that selects for the furthest-out zoom to arrange for Agent activations
- View range Agent & Object activation
  - ObjectRealOnCamera
    - Attempted
  - BrainUpdate.RogueVisionChecks()
  - BrainUpdate.DoObjectChecks()
  - Agent.AgentOnCamera()
    - This worked, but now they don't animate. They walk around statically, often tilted or upside down.
      - Attempted, Agent.Start
  - Agent.onCamera
  - Agent.wasOnCamera
  - PlayerAgent.agentCamera.ZoomFactor
  - PlayerControl.myCamera.zoomLevel
  - CameraScript.RealAwake
## Easy Mark
- Increase chance of pickpocket, mugging, and other victimization
- Small chance for people to short-change you when buying something
- Worse chances at Mugging & Extorting
- Possibly an opposite trait as well, Streetwise, that allows you to short-change and no chance of victimizations
## Fire mods

```
[Error  : Unity Log] NullReferenceException: Object reference not set to an instance of an object
Stack trace:
Fire.SpreadFireIfPossible (UnityEngine.Vector2 pos) (at <5b00a25014d74f7f862ecdd1d48f7c04>:0)
Fire+<FireSpread>d__67.MoveNext () (at <5b00a25014d74f7f862ecdd1d48f7c04>:0)
UnityEngine.SetupCoroutine.InvokeMoveNext (System.Collections.IEnumerator enumerator, System.IntPtr returnValueAddress) (at <73b499366e5241bda47e5da76897738b>:0)
UnityEngine.MonoBehaviour:StartCoroutine(IEnumerator)
BunnyMod.Content.BMMiscellaneous:Fire_UpdateFire(Fire)
Fire:UpdateFire()
Updater:UpdateOther()
Updater:Update()
```

- Might be one place using Instance instead of Base. Only non-routine thing done there.
- 
## Gang Tats
- Make compatible With Suspicious
## Generally Unpleasant 
- These are notes from the idea file, just double-check that all of these features are implemented:
  - All NPCs start out Annoyed. 
  - Cancels: The Law, Random Reverance, Friend of the common folk, friend of the family.
  - Excludes Aligned and Prisoners.
## Headshots
- Add: Headgear reduces damage
## Home Base Allies
- Remove this, it clutters the scene when people use circle indicators
## Initial Relationship
- Whatever you changed in this seemed to have broken it.
  - Ideological Clash turned people hostile but they didn't act it. 
    - Verify that you're not inappropriately referencing the not-yet-applied stored relationship variable to determine strikes. I think someone who would be Hostile is being set to neutral strikes.
## Mob Debt
- Per level: Annoyed from Level 1 / Hostile from level 5 / hit squads after Level 10
  - Attempted
- Extra xp for killing mobsters
  - Attempted. StatusEffects.AgentIsRival
## Mook Masher / Mob Debt
- Make them guilty in case you have The Law
  - Attempted
## Mutator List Collapsers (Copy ATOM)
- Attempted
## Objectively Unpleasant
- Some starting out hostile but not acting it. Also had The Law when I did this so not sure if it's a unique interaction.
## Objectively Unpleasant + vanilla Ideological Clash
- Hostiles were generated, but they weren't hostile.
  - Attempted adding Strikes
## PoliceBox
- Owncheck with normal cops not working on tamper?
## Priors
- Hostile cops don't act hostile
  - Attempted: Set Strikes
- Makes cops annoyed so you can't pay them off.
  - Attempted: Allowed bribe through ATM with Priors
## Reuse Base Methods called with AccessTools
- If there are base methods you use again and again, declare them in the class to save space and increase clarity, avoiding AccessTools mess.
  - One example is PlayfieldObject.DetermineButtons, which is used in every derived class from it.
## Security Cam & other objects
- Enable to start back on if deactivated via hack
## Slot Machine
- Non-Jackpot
  - Make "Win" ding number of times of multiplier for normal wins
    - Attempted
      - I don't think this will be right, because you need an Async task for it
- Make an Owner come and tell the winner they're cut off, but give them a free drink
  - This would be good to shelve for when you do a full gambling update.
- Jackpot
  - No longer shuts down other machines in chunk
  - Keeps showing music note (I think particle effect) after jackpot ended
    - __instance.stateIndicator.STtateIndicatorOff();
  - No dialogue
- Gate shutdown behind !NoLimits
  - Attempted
## Sniper +
- Shooting from hidden object
  - Attempted with BulletHitbox.OnTriggerEnter2D
    - DW, but see what logs are saying before deletion
- Check out vTrait.BulletsPassThroughObjects. It's in BulletHitBox.HitObject
- Consider Bullet.RayHit
- Model this one on Penetrating Bullets: BulletHitbox.HitObject
  - Attempted 
    - (If this doesn't work, try with eliminating BulletHitBox.OnTriggerEnter2d patch next)
- PFO.bulletsCanPass may determine raycast end of bullet
- Give some visual indicator, either as a SPecial Indicator over NPCs, or a color change on the aiming reticle, when you are able to do a headshot
- Ability Indicator at Range
  - May need to trigger StatusEffects.SpecialAbilityInterfaceCheck as if adding a Special Ability. Not sure this will be doable with a trait.
    - Call it in AddTrait.
  - Attempted
    - StatusEffect.AddTrait
    - StatusEffects.SpecialAbilityInterfaceCheck
    - Used placeholder Chloroform sprite
    - Used placeholder range without 2f range mod from hiding
## Stealth Bastard Deluxe
- Hide Offset adjustment
  - Plant
    - North Wall
    - South Wall
  - Big Table 
    - North Wall
    - South Wall
  - BathTub
    - South doesn't seem to work at least when it's not shoved to a north wall, bounces out.
    - This was the original one with the weird trapping collider with North.
    - So it looks like you need to detect whether it's pushed north, and do South then. Otherwise do North.
    - North Wall
    - South Wall
  - PoolTable
    - North Wall
    - South Wall
  - Trash Can
    - North Wall
    - South Wall
  - Play different audio when you hide in other stuff
    - Trash Can - ManholeOpen
    - Tables - Tumble/Fall
- Check out StatusEffects_BecomeNotHidden_Prefix
  - __instance.agent.hiddenInObject.objectCollider.enabled can be set to false for any that are especially stubborn with trapping players.
## Stove
- Allow remote hack (IOT)
  - This and others might be good with the Excess Granted overhaul
## Trait Conflict custom method 
- Add series of strings and Lists of strings
- Exclude self, give self as argument
- Trait conlficts are Unlock.cancellations
- Would be a good contribution to RL3
## Traits (All of them)
- Learn how to do trait types for leveling up
## Ultramyopic
- Showed up in level up traits, probably other negatives will too
  - This is apparently a RogueLibs bug, not mine.
## Veiled Threats
- Go hostile if Annoyed
  - Attempted
## Vendor Stand
- Show (Empty) after stolen from
## Very Hard On Yourself
- Added the following XP boni and mali, will need testing particularly with VHOY
  - AngeredMany = "AngeredMany",
  - BQMalusDowntown = "BQMalusDowntown",
  - BQMalusFloor = "BQMalusFloor",
  - BQMalusGame = "BQMalusGame",
  - BQMalusIndustrial = "BQMalusIndustrial",
  - BQMalusPark = "BQMalusPark",
  - BQMalusSlums = "BQMalusSlums",
  - BQMalusUptown = "BQMalusUptown",
  - ElectabilityMalus = "ElectabilityMalus",
  - FailedToFreePrisoners = "FailedToFreePrisoners",
  - StoleNone = "StoleNone",
  - TookLotsOfDamage = "TookLotsOfDamage";
- Show Innocent/Guilty indicators
  - Attempted
- Opposite
  - Unrepentant failure
    - Reduces XP loss for failures
## Warlord
- Remove XP Extortion Reward
  - Attempted
- Customize dialogue
  - Dialogue works, but need more variations
## Need XP rewards
- Burned Lots

#
# Fixing
Implemented features that have bug(s) that need to be fixed before release.

---

## StatusEffects.BecomeHidden 
- This is with the new logging added.
```
[Message: Bunny Mod] StatusEffects_BecomeHidden
[Message: Bunny Mod]    ObjectReal: null
[Message: Bunny Mod]    Agent: Cannibal
[Error  : Unity Log] NullReferenceException: Object reference not set to an instance of an object
Stack trace:
BunnyMod.Content.BMAgents.StatusEffects_BecomeHidden (ObjectReal hiddenInObject, StatusEffects __instance) (at <f2d762100f78492980360d55eb0b7e89>:0)
StatusEffects.BecomeHidden (ObjectReal hiddenInObject) (at <5b00a25014d74f7f862ecdd1d48f7c04>:0)
BunnyMod.Content.BMLevelGen+<LoadLevel_SetupMore3_3_Prefix_Replacement>d__33.MoveNext () (at <f2d762100f78492980360d55eb0b7e89>:0)
BunnyMod.Content.BMLevelGen+<LoadLevel_SetupMore3_3_Postfix>d__34.MoveNext () (at <f2d762100f78492980360d55eb0b7e89>:0)
UnityEngine.SetupCoroutine.InvokeMoveNext (System.Collections.IEnumerator enumerator, System.IntPtr returnValueAddress) (at <73b499366e5241bda47e5da76897738b>:0)
```

#
# Balancing
Implemented and Bugfixed features that need balancing before release.

---

## Pyromancy
- Refire delay is a little too long
## Telemancy
- Miscast chance with Wild Casting is way too high, or not accurate enough.
- Reduce or at least randomize Dizzy duration. Guessing 5s instead of 10s.


#
# Finalization
- Do renames *only when the code is complete*.
- Complete and win a run with each new feature, and successfully load a return to home base. This would be a full cycle of the code you can expect to run into.
- Make a promo character for each special ability or trait group, to promote the mod and community at large.
- Update Sprites
- Increment the Version Number!


#
# Shelved
Out-of-scope features and notes for them; any bugs not worth fixing yet; avenues for codebase exploration

---

- AccessTools argument additions (new Type[1] {etc} often missing)

- RandomSelection.LoadRandomness is a good place to find lists to modify 

- Targetable Items
  - InvItem.OperateItem appears to be near the beginning of this chain
    - Goes all the way down to ObjectReal.LaptopHack

- XP Rewards
  - Explore GC.Stats
  - Good for Path traits
    - Fire.DestroyMe() for Path Of Fire
